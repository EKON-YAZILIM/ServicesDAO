@using DAO_WebPortal.Resources
@using Helpers.Constants
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor httpContextAccessor
@model Helpers.Models.WebsiteViewModels.AuctionDetailViewModel

@{
    Layout = "~/Views/Shared/_MainLayout.cshtml";
}

@{
    string userType = httpContextAccessor.HttpContext.Session.GetString("UserType");

    //New bid button will be active for only authorized members
    if ((Model.Auction.Status == Enums.AuctionStatusTypes.InternalBidding && userType == Enums.UserIdentityType.VotingAssociate.ToString()) ||
        (Model.Auction.Status == Enums.AuctionStatusTypes.PublicBidding && userType == Enums.UserIdentityType.Associate.ToString()))
    {
        //If user is not job poster display new bid button
        if (httpContextAccessor.HttpContext.Session.GetInt32("UserID") != Model.Auction.JobPosterUserId)
        {
            <div class="row d-flex m-2">
                <div class="col-md-6 d-flex">
                </div>
                <div class="col-md-6 d-flex justify-content-end">
                    <a class="btn btn-primary" data-coreui-toggle="modal" data-coreui-target="#Auction-Modal">
                        <svg class="icon me-2">
                            <use xlink:href="/Home/images/svg/free.svg#cil-plus"></use>
                        </svg>New Bid
                    </a>
                </div>
            </div>
        }
    }

}

<!--Bids-->
<div class="card m-2">
    <div class="card-header">
        <!-- .header -->
        <span class="small ms-1">Auction Bids Table</span>
        <a href="../Job-Detail/@Model.Auction.JobID" class="float-right">Go to job details</a>
    </div><!-- .header -->
    <div class="card-body">
        <!-- Card Body -->
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Username</th>
                    <th scope="col">Price</th>
                    <th scope="col">Time</th>
                    @if (Model.Auction.Status == Enums.AuctionStatusTypes.InternalBidding)
                    {
                        <th scope="col">Reputation Stake</th>
                    }
                    <th scope="col"></th>
                </tr>
            </thead>
            <tbody>
                @{int Count = 0;}
                @foreach (var item in Model.BidItems)
                {
                    Count++;

                    <tr>
                        <th scope="row">@Count</th>
                        <td>@item.UserName</td>
                        <td>@item.Price</td>
                        <td>@item.Time</td>

                        @if (Model.Auction.Status == Enums.AuctionStatusTypes.InternalBidding)
                        {
                            <td>@item.ReputationStake</td>
                        }

                        <td>

                            @*If bidding continues, show buttons *@
                            @if (Model.Auction.Status == Enums.AuctionStatusTypes.InternalBidding || Model.Auction.Status == Enums.AuctionStatusTypes.PublicBidding)
                            {
                                @*If user is job poster , show select winner bid button *@
                                if (Model.Auction.JobPosterUserId == httpContextAccessor.HttpContext.Session.GetInt32("UserID"))
                                {
                                    <a class="btn btn-sm btn-primary me-2 cursorp" onclick="ChooseAsWinnerBidModal(@item.AuctionBidID)">
                                        <svg class="icon">
                                            <use xlink:href="/Home/images/svg/free.svg#cil-star"></use>
                                        </svg> Select Winner
                                    </a>
                                }

                                @*If user already have bid, show delete bid button *@
                                if (item.UserId == httpContextAccessor.HttpContext.Session.GetInt32("UserID"))
                                {
                                    <a class="btn btn-sm btn-primary me-2" data-coreui-toggle="modal" data-coreui-target="#DeleteBidModal">
                                        <svg class="icon">
                                            <use xlink:href="/Home/images/svg/free.svg#cil-trash"></use>
                                        </svg> Delete Bid
                                    </a>
                                }
                            }

                            @*Show winner bid icon*@
                            @if (item.AuctionBidID == Model.Auction.WinnerAuctionBidID)
                            {
                                <i style="color:#FFD700" class="fas fa-star cursorp" title="Winner Bid"></i>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div><!-- Card Body -->
</div>

<!--New Bid Modal  -->
<div class="modal fade" id="Auction-Modal" tabindex="-1" aria-labelledby="AddAuction" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="AddAuction">New Bid for Auction #@Model.Auction.AuctionID</h5>
                <button class="btn-close" type="button" data-coreui-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" for="price">Price</label>
                    <input class="form-control" id="price" type="text" placeholder="Price">
                </div>
                <div class="mb-3">
                    <label class="form-label" for="time">Time</label>
                    <input class="form-control" id="time" type="text" placeholder="Time">
                </div>
                @if (Model.Auction.Status == Enums.AuctionStatusTypes.InternalBidding)
                {
                    <div class="mb-3">
                        <label class="form-label" for="reputation">ReputationStake</label>
                        <input class="form-control" id="reputation" type="text" placeholder="Reputation">
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-coreui-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" onclick="AuctionBidAdd(this,@Model.Auction.AuctionID);">Submit Bid</button>
            </div>
        </div>
    </div>
</div>

@{
    var userBid = Model.BidItems.SingleOrDefault(x => x.UserId == httpContextAccessor.HttpContext.Session.GetInt32("UserID"));

    if (userBid != null)
    {
        <!--Delete Bid Modal  -->
        <div class="modal fade" id="DeleteBidModal" tabindex="-1" aria-labelledby="AddAuction" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="AddAuction">Delete Bid</h5>
                        <button class="btn-close" type="button" data-coreui-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete the bid?
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" data-coreui-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" onclick="DeleteBid(this,@userBid.AuctionBidID);">Delete Bid</button>
                    </div>
                </div>
            </div>
        </div>
    }
}

<!--Select Winner Bid Modal  -->
<div class="modal fade" id="SelectWinnerBidModal" tabindex="-1" aria-labelledby="AddAuction" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="AddAuction">Delete Bid</h5>
                <button class="btn-close" type="button" data-coreui-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to select bid #<span id="winnerBidNo"></span> as winner?
            </div>
            <div id="winnerButtons" class="modal-footer">
                <button class="btn btn-secondary" type="button" data-coreui-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" onclick="ChooseAsWinnerBid(this,this.id,@Model.Auction.AuctionID);">Select Bid</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{

    <script>

            //Auction bids adding function
            function AuctionBidAdd(e, id) {
                $(e).prop("disabled", true);
                $(e).html('<i class="fas fa-circle-notch fa-spin"></i> Submitting Bid..');
                    //Create auction bid model
                    var price = $('#price').val()
                    var time = $('#time').val();
                     //Ajax post action
                    $.ajax({
                        type: "POST",
                        url: "../Home/Auction_Bid_Add",
                        data: {
                            "price": price,
                            "time": time,
                            "auctionid": id,
                            @if (Model.Auction.Status == Enums.AuctionStatusTypes.InternalBidding) { <text> "reputationStake": $('#reputation').val() </text> }
                        },
                        success: function (result) {
                            if (result.success) {
                                window.location.reload();
                            }
                            else {
                                toastr.warning(result.message);
                            }
                            $(e).prop("disabled", false);
                            $(e).html('Submit Bid');
                        },
                        failure: function (response) {
                            toastr.warning("@Lang.ConnectionError");
                            $(e).prop("disabled", false);
                            $(e).html('Submit Bid');
                        },
                        error: function (response) {
                            toastr.error("@Lang.UnexpectedError");
                            $(e).prop("disabled", false);
                            $(e).html('Submit Bid');
                        }
                    });

                }

            //Bid delete function
            function DeleteBid(e, bidId) {
                $.confirm({
                    title: 'Confirmation',
                    content: 'Are you sure you want to delete your bid ?',
                    buttons: {
                        cancel: {
                            text: 'Cancel'
                        },
                        confirm: {
                            text: 'Continue',
                            btnClass: 'btn btn-primary',
                            action: function () {
                                $(e).prop("disabled", true);
                                $(e).html('<i class="fas fa-circle-notch fa-spin"></i> Deleting Bid..');
                                    //Ajax get action
                                    $.ajax({
                                        type: "GET",
                                        url: "../Home/Auction_Bid_Delete",
                                        data: {
                                            "id": bidId,
                                        },
                                        success: function (result) {
                                            if (result.success) {
                                                window.location.reload();
                                            }
                                            else {
                                                toastr.warning(result.message);
                                            }
                                        },
                                        failure: function (response) {
                                             toastr.warning("@Lang.ConnectionError");
                                        },
                                        error: function (response) {
                                             toastr.error("@Lang.UnexpectedError");
                                        }
                                    });
                                $(e).prop("disabled", false);
                                $(e).html('Delete Bid');
                            }
                        }
                    }
                });
            }

            //Opens confirmation modal
            function ChooseAsWinnerBidModal(id) {
                $("#winnerBidNo").text(id);
                $("#winnerButtons button:nth-of-type(2)").attr("id", id);
                $("#SelectWinnerBidModal").modal("toggle");
            }

            //Select winner bid function
            function ChooseAsWinnerBid(e, bidId, auctionId) {
                $(e).prop("disabled", true);
                $(e).html('<i class="fas fa-circle-notch fa-spin"></i> Selecting Bid..');
                     //Ajax post action
                    $.ajax({
                        type: "GET",
                        url: "../Home/ChooseWinnerBid",
                        data: {
                            "bidId": bidId,
                            "auctionId": auctionId,
                            "jobid":@Model.Auction.JobID
                        },
                        success: function (result) {
                                if (result.success) {
                                    window.location.reload();
                                }
                                else {
                                    toastr.warning(result.message);
                                }
                            },
                        failure: function (response) {
                             toastr.warning("@Lang.ConnectionError");
                        },
                        error: function (response) {
                             toastr.error("@Lang.UnexpectedError");
                        }
                    });
                $(e).prop("disabled", false);
                $(e).html('Select Bid');
            }

    </script>
}

